<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Rowing test</title>
        <link rel="stylesheet" href="style.css" media="screen">
        <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/dojo/1.10.1/dijit/themes/claro/claro.css" media="screen">
<style type="text/css">
body,html { height:100%; }
</style>
    </head>
    <body class="claro">
        <p id="error"></p>
        <div id="appLayout" class="demoLayout">
        </div>
        <!-- load dojo and provide config via data attribute -->
        <script type="text/javascript" src="http://openlayers.org/api/2.10/OpenLayers.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/dojo/1.10.1/dojo/dojo.js"
                data-dojo-config="async: 1, packages: [ {
                                      name: 'js',
                                      location: location.pathname.replace(/\/[^/]+$/, '') + '/js' }]" >
        </script>
        <script>
        function create_new_outing_tab( main )
        {
                require(["js/ajax","dojo/store/Memory","dojo/on","dijit/form/Form", "dijit/form/MultiSelect", "dijit/form/FilteringSelect","dijit/layout/ContentPane","dojo/_base/window",
                         "dojox/form/Uploader",
                    "dijit/form/Button", "dojox/layout/TableContainer", "dijit/form/TextBox", "dijit/form/CheckBox", "dojo/domReady!"],
                function(ajax, Memory, on, Form, MultiSelect, FilteringSelect, ContentPane, win, Uploader, Button, TableContainer, TextBox, CheckBox){
                        // create the BorderContainer and attach it to our appLayout div
                /*
                        main.addChild( new Button ( { label: "Upload", onClick: function() { console.log("First button was clicked");
                                                }}));
                        main.addChild( new Button ( { label: "Second", onClick: function() { console.log("Second button was clicked");
                                                }}));
                       */

                var form = new Form( { action: "add_outing.php", method:"post", encType:"multipart/form-data"});
                var table = new TableContainer( { cols: 2, showLabels:false } );
                var title = new TextBox( { name: "title"} );
                var loc = new TextBox( { name: "location", value:"Cam"} );

                table.addChild( new ContentPane({content: "Title:"}));
                table.addChild( title );

                table.addChild( new ContentPane({content: "Location:"}));
                table.addChild( loc );
                table.addChild( new ContentPane({content: "Boat:"}));
                var boat = new MultiSelect({ multiple : "false", name: "boat"});
                ajax.get_boats( function( boats )
                {
                        var first = true;
                        for( var b of boats )
                        {
                                var opt = win.doc.createElement('option');
                                opt.innerHTML = b.name;
                                opt.value = b.num_rowers +","+ b.cox+","+b.id;
                                if(first)
                                {
                                        opt.selected = "selected";
                                        first = false;
                                }
                                boat.containerNode.appendChild(opt);
                        }
                });

                var num_rowers = 0;
                var people = [
                        { name : "Uploader", show: true },
                        { name : "Cox", show: false },
                        { name : "Stroke", show: false},
                        { name : 7, show: false},
                        { name : 6, show: false},
                        { name : 5, show: false},
                        { name : 4, show: false},
                        { name : 3, show: false},
                        { name : 2, show: false},
                        { name : "Bow",  show: false},
                        { name : "Coach", show: true}
                ];
                boat.startup();
                table.addChild( boat );

                var rowersStore = new Memory();
                ajax.get_rowers( function( rowers )
                {
                        for( var b of rowers )
                        {
                                rowersStore.put( { id: b.id, name: b.firstName + " " + b.lastName} );
                        }
                });

                var peopleNodes = new Array();
                for(var p of people )
                {
                        var newNode = { label: new ContentPane({content: p.name+":", id:p.name+"Lbl", style: "display:" + (p.show ? "block" : "none")+";"}),
                                        select: new FilteringSelect({store: rowersStore, id:p.name+"Select", name: p.name+"Select", style: "display:" + (p.show ? "block" : "none")+";"})
                        };
                        table.addChild( newNode.label );
                        table.addChild( newNode.select );
                        peopleNodes[p.name] = newNode;
                }

                on( boat, "change", function(evt){
                                var val = String(evt).split(",");
                                var num_rowers = parseInt(val[0]);
                                // Show cox ?
                                console.log("num_rowers = "+num_rowers+" val[1] = "+val[1]);
                                people[1].show = val[1] == 1;
                                people[2].show = num_rowers > 1;
                                people[3].show = num_rowers == 8;
                                people[4].show = num_rowers == 8;
                                people[5].show = num_rowers == 8;
                                people[6].show = num_rowers == 8;
                                people[7].show = num_rowers >= 4;
                                people[8].show = num_rowers >= 4;
                                people[9].show = num_rowers > 1;
                                console.log("1 = "+people[1].show);

                                for( p of people )
                                {
                                        console.log("Name "+p.name+" show "+p.show);
                                        peopleNodes[p.name].label.set("style","display:" + (p.show ? "block" : "none"));
                                        peopleNodes[p.name].select.set("style","display:" +(p.show ? "block" : "none"));
                                        //peopleNodes[p.name].select.set("required", p.show ? "true" : "false" );
                                }

                                });

                table.addChild( new ContentPane({content: "TCX track:"}));
                var uploader = new Uploader( { multiple:false, type:"submit", id: "tcxBtn", label:"Choose file" } ) 
                var fileCell = new TableContainer( { cols : 2, showLabels : false } );
                var filename = new ContentPane( );
                fileCell.addChild( uploader );
                fileCell.addChild(filename);

                on( uploader, "change", function(evt){
                                filename.set( "content", evt[0].name);
                                });

                table.addChild( fileCell );
                table.addChild( new Button( { type : "submit", label:"Upload"}));
                var errorsPane = new ContentPane();
                table.addChild( errorsPane );

                table.placeAt( form.containerNode );

                on (form, "submit", function(evt){
                                var errors = "";
                                if( filename.get("content") == "" )
                                        errors += "You need to select a TCX file to upload<br/>";
                                if( title.value == "")
                                        errors += "Please enter a Title for the outing<br/>";
                                if( loc.value == "")
                                        errors += "Please enter a Location for the outing<br/>";

                                for( p of people )
                                {
                                        if( p.show  && peopleNodes[p.name].select.value == "" && p.name != "Coach")
                                                errors += "Please select a "+ p.name+"<br/>";
                                }
                                var boat_array= String(boat.value).split(",");
                                if( boat_array.length > 2 )
                                {
                                        console.log("Boat: "+ boat_array[2]);
                                }
                                else
                                        console.log("Boat: ERG");

                                console.log( "Title: "+title.value);
                                console.log( "Uploader: "+peopleNodes["Uploader"].select.value);
                                errorsPane.set("content",errors)
                                //alert( errors );

                                return errors == "";
                                });
                main.addChild( form );
                });
        }

        function create_recent_outings_tab( main )
        {
                require(["js/ajax","js/utils","dojo/ready", "dojox/geo/openlayers/Map", "dojox/geo/openlayers/GfxLayer",
                          "dojox/geo/openlayers/GeometryFeature", "dojox/geo/openlayers/Point","dojo/_base/window","dojox/geo/openlayers/Collection",
                          "dojo/on", "dijit/Tooltip", "dojo/_base/lang","dojo/_base/array","dojo/dom-geometry", "dojox/geo/openlayers/LineString", 
                          "dojo/_base/Color","dijit/form/MultiSelect", "dijit/form/Select","dojox/layout/TableContainer","dijit/layout/ContentPane","dijit/form/Form", 
                          "dijit/form/CheckBox", "dijit/form/RadioButton", "js/url" ],
                     function(ajax, utils, ready, Map, GfxLayer, GeometryFeature, Point, win, Collection,on, Tooltip, lang, arr, domGeom, LineString, 
                             Color, MultiSelect, Select, TableContainer, ContentPane, Form, CheckBox, RadioButton, url){

                ready(function(){
                // create a map widget.
                var main_table = new TableContainer( { cols: 1, showLabels: false, style:'height:100%;'} );
                /*
                var type_select = new Select( { options : [ 
                        { label : 'Recent outings' , value:'recent', selected: true}, 
                        { label : 'Personal Bests' , value:'pbs'} ] } );
                if( url.get("type_select") )
                {
                       //Check it's a valid option:
                       for( opt of type_select.options )
                       {
                                if( opt.value == url.get("type_select") )
                                {
                                        type_select.set('value', url.get("type_select"));
                                        break;
                                }
                       }
                }
                if( type_select.value != url.get("type_select") )
                {
                        url.set("type_select", type_select.value);
                }

                type_select.on("change", function(new_value) { 
                        url.set("type_select", new_value);
                        } );
                        */


                var map_container = new ContentPane( { style:'height:100%;' });
                var menu_table = new TableContainer( { cols: 3, showLabels: false, style:'width:400px;white-space:nowrap;'} );
                var outings_table = new TableContainer( { cols: 2, showLabels: true} );
                var selection_table = new TableContainer( { cols: 1, showLabels: false} );
                var recent_selected = new RadioButton( { checked: true, value : "recent", name: "view_selection" });
                var pbs_selected = new RadioButton( { checked: false, value : "pbs", name: "view_selection" });
                menu_table.addChild( new ContentPane({content: "View: "}));
                selection_table.addChild( recent_selected );
                selection_table.addChild( pbs_selected );
                main_table.addChild( menu_table );
                main_table.addChild( outings_table );

                //TODO: Add DataGrid to outings_table with selectionMode=single

                var pbs_categories = new Select ({ options : [
                        { label : 'Per crew', value:'pb_crew', selected : true },
                        { label : 'Per boat', value:'pb_boat' }
                        ], style: "display: none" } );

                var crews = new MultiSelect( { multiple : "true", name: "crews", style: "display: none;" } );
                //FIXME: Should be get_crews()
                ajax.get_boats( function( boats )
                {
                        var first = true;
                        for( var b of boats )
                        {
                                var opt = win.doc.createElement('option');
                                opt.innerHTML = b.name;
                                opt.value = b.num_rowers +","+ b.cox+","+b.id;
                                if(first)
                                {
                                        opt.selected = "selected";
                                        first = false;
                                }
                                crews.containerNode.appendChild(opt);
                        }
                });


                var filter_crew = new CheckBox( { id: "filter_crew", checked: false, onChange: function(b) { 
                                crews.set("style","display:" + (b ? "block" : "none"));
                                } });
                menu_table.addChild( filter_crew );

                var boats = new MultiSelect( { multiple : "true", name: "boats", style: "display: none;" } );
                ajax.get_boats( function( boat_list )
                {
                        var first = true;
                        for( var b of boat_list )
                        {
                                var opt = win.doc.createElement('option');
                                opt.innerHTML = b.name;
                                opt.value = b.id;
                                if(first)
                                {
                                        opt.selected = "selected";
                                        first = false;
                                }
                                boats.containerNode.appendChild(opt);
                        }
                });
                var filter_boat = new CheckBox( { id: "filter_boat", checked: false, onChange: function(b) { 
                                boats.set("style","display:" + (b ? "block" : "none"));
                                } });
                menu_table.addChild( filter_boat );

                menu_table.addChild( selection_table );
                menu_table.addChild( crews );
                menu_table.addChild( boats );

                function create_label( cb, txt )
                {
                        var lbl =  win.doc.createElement("label", { "for": cb.id});
                        lbl.innerHTML = txt;
                        cb.domNode.parentNode.appendChild( lbl );
                }
                main.addChild( main_table );
                create_label( filter_crew, "Filter by crew");
                create_label( filter_boat, "Filter by boat");
                create_label( recent_selected, "Recent outings");
                create_label( pbs_selected, "Personal Bests");
                main_table.addChild( map_container );

                    var map = new Map(map_container.containerNode);
                   // This is New York
                    var ny = {
                      latitude : 40.71427,
                      longitude : -74.00597
                    };
                    // create a GfxLayer
                    var layer = new GfxLayer();
                    // add layer to the map
                    map.addLayer(layer);
                    // fit to New York with 0.1 degrees extent

                        var localXY = function(p){
                                var x = p.x;
                                var y = p.y;
                                var layer = map.olMap.baseLayer;
                                var resolution = map.olMap.getResolution();
                                var extent = layer.getExtent();
                                console.log(extent);
                                var rx = (x / resolution + (-extent.left / resolution));
                                var ry = ((extent.top / resolution) - y / resolution);
                                return [rx, ry];
                        };

                ajax.get_trackpoints( 12492, 12522, function( pts )
                {
                        var min = { latitude : parseFloat(pts[0].latitude), longitude : parseFloat(pts[0].longitude) } ;
                        var max = { latitude : parseFloat(pts[0].latitude), longitude : parseFloat(pts[0].longitude) } ;
                        var min_speed = 3.77777;
                        var max_speed = 4.1994;
                        var prev = null;
                        var mins = 100;
                        var maxs = 0;
                        arr.forEach( pts, function(p)
                        {
                                var latitude = parseFloat( p.latitude );
                                var longitude = parseFloat( p.longitude );
                                var speed = parseFloat( p.speed );
                                if( latitude > max.latitude ) max.latitude = latitude ;
                                else if( latitude < min.latitude ) min.latitude = latitude ;
                                if( longitude > max.longitude ) max.longitude = longitude ;
                                else if( longitude < min.longitude ) min.longitude = longitude ;
                                //FIXME Remove this
                                if( speed > maxs ) maxs = speed;
                                else if( speed < mins) mins = speed;

                                var ratio = (p.speed - min_speed ) / (max_speed - min_speed );
                                var colour = Color.blendColors( Color.fromArray([255,0,0]), Color.fromArray([0,255,0]), ratio);
                                //console.log(colour+" Ratio : "+ratio);

                                if( prev)
                                {
                                        var diff_longitude = longitude - prev.longitude;
                                        var diff_latitude = latitude - prev.latitude;

                                        var start = prev;
                                        for( var i = 0.25; i <= 1.0; i += 0.25 )
                                        {
                                                var new_pt = { longitude: prev.longitude + i*diff_longitude, 
                                                        latitude:prev.latitude + i * diff_latitude, 
                                                        colour: Color.blendColors( prev.colour, colour, i ) };

                                                var line = new LineString( [{x:start.longitude,y:start.latitude},{x:new_pt.longitude,y:new_pt.latitude}]);
                                                var f = new GeometryFeature(line);
                                                f.setStroke({color: start.colour, width: 3});
                                                layer.addFeature(f);
                                                start = new_pt;
                                        }

                                }

                                prev = { longitude: longitude, latitude:latitude, colour: colour};

                                var pt = new Point( {x:longitude,y:latitude} );
                            var f = new GeometryFeature(pt);
                            var size = 2;
                            // set the shape properties, fill and stroke
                            //f.setFill([ 0, 128, 128 ]);
                            f.setStroke([ 0, 0, 0, 1 ]);
                            f.setShapeProperties({
                              r : 2
                            });
                            pt.tooltip= (p.speed * 3.6).toFixed(2) + " kph, dist: "+(p.distance / 1000).toFixed(2)+" km, time: "+ utils.time_to_str(p.time);
                            // add the feature to the layer
                            layer.addFeature(f);
                            f.getShape();
                             pt.shape.connect("onmouseover",function(evt){
                                             //evt.relatedTarget
                                             Tooltip.show(pt.tooltip, {x:evt.pageX, y:evt.pageY, w:2, h:2});
                                                });
                             pt.shape.connect("onmouseout", function(){
                                                                //FIXME: Doesn't work
                                             Tooltip.hide(pt.shape);
                                                        });
                        });
                        console.log("Min speed : "+mins+" Max speed : "+ maxs);
                        console.log(min.latitude+" , "+min.longitude+" / "+max.latitude+" , "+max.longitude);
                    map.fitTo({
                    bounds :[ min.longitude,min.latitude,max.longitude,max.latitude ]
                    });

                });
            });
            });
        }

        function create_search_tab( main )
        {
        }

        function create_main_layout()
        {
                require(["dijit/registry", "dijit/layout/BorderContainer",
                    "dijit/layout/TabContainer", "dijit/layout/ContentPane", "dijit/layout/SplitContainer","dijit/form/Button","js/url","dojo/domReady!"],
                function(registry, BorderContainer, TabContainer, ContentPane, SplitContainer, Button, url){
                        // create the BorderContainer and attach it to our appLayout div
                        var appLayout = new BorderContainer({
                            design: "headline"
                        }, "appLayout");

                        // create the TabContainer
                        var contentTabs = new TabContainer({
                            region: "center",
                            id: "contentTabs",
                            tabPosition: "top",
                            "class": "centerPanel"
                        });

                        // add the TabContainer as a child of the BorderContainer
                        appLayout.addChild( contentTabs );

                        // create and add the BorderContainer edge regions
                        appLayout.addChild(
                            new ContentPane({
                                region: "top",
                                "class": "edgePanel",
                                content: "Header content (top)"
                            })
                        );
                        /*
                        appLayout.addChild(
                            new ContentPane({
                                region: "left",
                                id: "leftCol", "class": "edgePanel",
                                content: "Sidebar content (left)",
                                splitter: true
                            })
                        );
                        */

                        var tabs = new Array();
                        tabs.push( new ContentPane({ title: "Recent outings", id:"recent", factory: create_recent_outings_tab } ));
                        //tabs.push( new ContentPane({ title: "Search", id:"search", factory: create_search_tab } ));
                        tabs.push( new ContentPane({ title: "Add a new outing", id:"add", factory: create_new_outing_tab } ));
                        tabs.push( new ContentPane({ title: "Add/Edit rowers", id:"rowers" } ));
                        tabs.push( new ContentPane({ title: "Add/Edit crews", id:"crews" } ));
                        tabs.push( new ContentPane({ title: "Add/Edit boats", id:"boats" } ));
                        tabs.push( new ContentPane({ title: "Edit pieces", id:"pieces" } ));
                        tabs.push( new ContentPane({ title: "Add/Edit PB distances", id:"distances" } ));
                        if( ! url.get("tab") )
                        {
                                url.set("tab",tabs[0].id);
                        }
                        for( var tab of tabs )
                        {
                                contentTabs.addChild( tab );
                                if( url.get("tab") == tab.id )
                                {
                                        tab.factory( tab );
                                        tab.factory = null;
                                        contentTabs.selectChild( tab );
                                }
                        }

                        contentTabs.watch("selectedChildWidget", function(name, oval, nval){
                                if( nval.factory )
                                {
                                        nval.factory( nval );
                                        nval.factory = null;
                                }
                                url.set( "tab", nval.id);
                                            });


                        // start up and do layout
                        appLayout.startup();
                });
        }
        create_main_layout();
        </script>
    </body>
</html>
