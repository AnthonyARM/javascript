<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Rowing test</title>
        <link rel="stylesheet" href="style.css" media="screen">
        <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/dojo/1.10.1/dijit/themes/claro/claro.css" media="screen">
<style type="text/css">
body,html { height:100%; }
</style>
    </head>
    <body class="claro">
        <p id="error"></p>
        <div id="appLayout" class="demoLayout">
        </div>
        <!-- load dojo and provide config via data attribute -->
        <script type="text/javascript" src="http://openlayers.org/api/2.10/OpenLayers.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/dojo/1.10.1/dojo/dojo.js"
                data-dojo-config="async: 1">
        </script>
        <script>
        var hashes = null;
        require(["dojo/io-query","dojo/hash"], function(ioQuery,hash) 
        {
                hashes = ioQuery.queryToObject(hash()); //get
        });
        function update_url()
        {
                require(["dojo/io-query","dojo/hash"], function(ioQuery,hash) 
                {
                        hash( ioQuery.objectToQuery(hashes)); //set url
                });
        }

        function get_boats( cb )
        {
                require([
                        'dojo/_base/xhr',
                        'dojo/json',
                        ], function(xhr,json) {
                        xhr.post({
                                // The URL of the request
                                url: "db_select.php",
                                // No content property -- just send the entire form
                                content: { query: "SELECT * from Boats" },
                                // The success handler
                                load: function(response)
                                {
                                        cb( json.parse( response, true ));
                                }
                        });
                        });
        }
        function get_trackpoints( id_start, id_end, cb )
        {
                require([
                        'dojo/_base/xhr',
                        'dojo/json',
                        ], function(xhr,json) {
                        xhr.post({
                                // The URL of the request
                                url: "db_select.php",
                                // No content property -- just send the entire form
                                content: { query: "SELECT * from TrackPoints where id between "+id_start+" AND "+id_end },
                                // The success handler
                                load: function(response)
                                {
                                        cb( json.parse( response, true ) );
                                }
                        });
                        });
        }
        function get_rowers( cb )
        {
                require([
                        'dojo/_base/xhr',
                        'dojo/json',
                        ], function(xhr,json) {
                        xhr.post({
                                // The URL of the request
                                url: "db_select.php",
                                // No content property -- just send the entire form
                                content: { query: "SELECT * from Rowers" },
                                // The success handler
                                load: function(response)
                                {
                                        cb( json.parse( response, true ) );
                                }
                        });
                        });
        }
        function create_new_outing_tab( main )
        {
                require(["dojo/store/Memory","dojo/on","dijit/form/Form", "dijit/form/MultiSelect", "dijit/form/FilteringSelect","dijit/layout/ContentPane","dojo/_base/window",
                         "dojox/form/Uploader",
                    "dijit/form/Button", "dojox/layout/TableContainer", "dijit/form/TextBox", "dijit/form/CheckBox", "dojo/domReady!"],
                function(Memory, on, Form, MultiSelect, FilteringSelect, ContentPane, win, Uploader, Button, TableContainer, TextBox, CheckBox){
                        // create the BorderContainer and attach it to our appLayout div
                /*
                        main.addChild( new Button ( { label: "Upload", onClick: function() { console.log("First button was clicked");
                                                }}));
                        main.addChild( new Button ( { label: "Second", onClick: function() { console.log("Second button was clicked");
                                                }}));
                       */

                var form = new Form( { action: "add_outing.php", method:"post", encType:"multipart/form-data"});
                var table = new TableContainer( { cols: 2, showLabels:false } );
                var title = new TextBox( { name: "title"} );
                var loc = new TextBox( { name: "location", value:"Cam"} );

                table.addChild( new ContentPane({content: "Title:"}));
                table.addChild( title );

                table.addChild( new ContentPane({content: "Location:"}));
                table.addChild( loc );
                table.addChild( new ContentPane({content: "Boat:"}));
                var boat = new MultiSelect({ multiple : "false", name: "boat"});
                get_boats( function( boats )
                {
                        var first = true;
                        for( var b of boats )
                        {
                                var opt = win.doc.createElement('option');
                                opt.innerHTML = b.name;
                                opt.value = b.num_rowers +","+ b.cox+","+b.id;
                                if(first)
                                {
                                        opt.selected = "selected";
                                        first = false;
                                }
                                boat.containerNode.appendChild(opt);
                        }
                });

                var num_rowers = 0;
                var people = [
                        { name : "Uploader", show: true },
                        { name : "Cox", show: false },
                        { name : "Stroke", show: false},
                        { name : 7, show: false},
                        { name : 6, show: false},
                        { name : 5, show: false},
                        { name : 4, show: false},
                        { name : 3, show: false},
                        { name : 2, show: false},
                        { name : "Bow",  show: false},
                        { name : "Coach", show: true}
                ];
                boat.startup();
                table.addChild( boat );

                var rowersStore = new Memory();
                get_rowers( function( rowers )
                {
                        for( var b of rowers )
                        {
                                rowersStore.put( { id: b.id, name: b.firstName + " " + b.lastName} );
                        }
                });

                var peopleNodes = new Array();
                for(var p of people )
                {
                        var newNode = { label: new ContentPane({content: p.name+":", id:p.name+"Lbl", style: "display:" + (p.show ? "block" : "none")+";"}),
                                        select: new FilteringSelect({store: rowersStore, id:p.name+"Select", name: p.name+"Select", style: "display:" + (p.show ? "block" : "none")+";"})
                        };
                        table.addChild( newNode.label );
                        table.addChild( newNode.select );
                        peopleNodes[p.name] = newNode;
                }

                on( boat, "change", function(evt){
                                var val = String(evt).split(",");
                                var num_rowers = parseInt(val[0]);
                                // Show cox ?
                                console.log("num_rowers = "+num_rowers+" val[1] = "+val[1]);
                                people[1].show = val[1] == 1;
                                people[2].show = num_rowers > 1;
                                people[3].show = num_rowers == 8;
                                people[4].show = num_rowers == 8;
                                people[5].show = num_rowers == 8;
                                people[6].show = num_rowers == 8;
                                people[7].show = num_rowers >= 4;
                                people[8].show = num_rowers >= 4;
                                people[9].show = num_rowers > 1;
                                console.log("1 = "+people[1].show);

                                for( p of people )
                                {
                                        console.log("Name "+p.name+" show "+p.show);
                                        peopleNodes[p.name].label.set("style","display:" + (p.show ? "block" : "none"));
                                        peopleNodes[p.name].select.set("style","display:" +(p.show ? "block" : "none"));
                                        //peopleNodes[p.name].select.set("required", p.show ? "true" : "false" );
                                }

                                });

                table.addChild( new ContentPane({content: "TCX track:"}));
                var uploader = new Uploader( { multiple:false, type:"submit", id: "tcxBtn", label:"Choose file" } ) 
                var fileCell = new TableContainer( { cols : 2, showLabels : false } );
                var filename = new ContentPane( );
                fileCell.addChild( uploader );
                fileCell.addChild(filename);

                on( uploader, "change", function(evt){
                                filename.set( "content", evt[0].name);
                                });

                table.addChild( fileCell );
                table.addChild( new Button( { type : "submit", label:"Upload"}));
                var errorsPane = new ContentPane();
                table.addChild( errorsPane );

                table.placeAt( form.containerNode );

                on (form, "submit", function(evt){
                                var errors = "";
                                if( filename.get("content") == "" )
                                        errors += "You need to select a TCX file to upload<br/>";
                                if( title.value == "")
                                        errors += "Please enter a Title for the outing<br/>";
                                if( loc.value == "")
                                        errors += "Please enter a Location for the outing<br/>";

                                for( p of people )
                                {
                                        if( p.show  && peopleNodes[p.name].select.value == "" && p.name != "Coach")
                                                errors += "Please select a "+ p.name+"<br/>";
                                }
                                var boat_array= String(boat.value).split(",");
                                if( boat_array.length > 2 )
                                {
                                        console.log("Boat: "+ boat_array[2]);
                                }
                                else
                                        console.log("Boat: ERG");

                                console.log( "Title: "+title.value);
                                console.log( "Uploader: "+peopleNodes["Uploader"].select.value);
                                errorsPane.set("content",errors)
                                //alert( errors );

                                return errors == "";
                                });
                main.addChild( form );
                });
        }

        function create_recent_outings_tab( main )
        {
                require(["dojo/ready", "dojox/geo/openlayers/Map", "dojox/geo/openlayers/GfxLayer",
                          "dojox/geo/openlayers/GeometryFeature", "dojox/geo/openlayers/Point","dojo/_base/window","dojox/geo/openlayers/Collection",
                          "dojo/on", "dijit/Tooltip", "dojo/_base/lang","dojo/_base/array","dojo/dom-geometry", "dojox/geo/openlayers/LineString", "dojo/_base/Color" ],
                     function(ready, Map, GfxLayer, GeometryFeature, Point, win, Collection,on, Tooltip, lang, arr, domGeom, LineString, Color){

                ready(function(){
                // create a map widget.
                var map_div = win.doc.createElement('div');
                map_div.style.height = "400px";
                map_div.style.width = "600px";
                main.containerNode.appendChild(map_div );

                    var map = new Map(map_div);
                   // This is New York
                    var ny = {
                      latitude : 40.71427,
                      longitude : -74.00597
                    };
                    // create a GfxLayer
                    var layer = new GfxLayer();
                    // add layer to the map
                    map.addLayer(layer);
                    // fit to New York with 0.1 degrees extent

                        var localXY = function(p){
                                var x = p.x;
                                var y = p.y;
                                var layer = map.olMap.baseLayer;
                                var resolution = map.olMap.getResolution();
                                var extent = layer.getExtent();
                                console.log(extent);
                                var rx = (x / resolution + (-extent.left / resolution));
                                var ry = ((extent.top / resolution) - y / resolution);
                                return [rx, ry];
                        };

                get_trackpoints( 12815, 12895, function( pts )
                {
                        var min = { latitude : parseFloat(pts[0].latitude), longitude : parseFloat(pts[0].longitude) } ;
                        var max = { latitude : parseFloat(pts[0].latitude), longitude : parseFloat(pts[0].longitude) } ;
                        var min_speed = 2.4447;
                        var max_speed = 4.79639;
                        var prev = null;
                        var mins = 100;
                        var maxs = 0;
                        arr.forEach( pts, function(p)
                        {
                                var latitude = parseFloat( p.latitude );
                                var longitude = parseFloat( p.longitude );
                                var speed = parseFloat( p.speed );
                                if( latitude > max.latitude ) max.latitude = latitude ;
                                else if( latitude < min.latitude ) min.latitude = latitude ;
                                if( longitude > max.longitude ) max.longitude = longitude ;
                                else if( longitude < min.longitude ) min.longitude = longitude ;
                                //FIXME Remove this
                                if( speed > maxs ) maxs = speed;
                                else if( speed < mins) mins = speed;

                                var ratio = (p.speed - min_speed ) / (max_speed - min_speed );
                                var colour = Color.blendColors( Color.fromArray([255,0,0]), Color.fromArray([0,255,0]), ratio);
                                console.log(colour+" Ratio : "+ratio);

                                if( prev)
                                {
                                        var diff_longitude = longitude - prev.longitude;
                                        var diff_latitude = latitude - prev.latitude;

                                        var start = prev;
                                        for( var i = 0.25; i <= 1.0; i += 0.25 )
                                        {
                                                var new_pt = { longitude: prev.longitude + i*diff_longitude, 
                                                        latitude:prev.latitude + i * diff_latitude, 
                                                        colour: Color.blendColors( prev.colour, colour, i ) };

                                                var line = new LineString( [{x:start.longitude,y:start.latitude},{x:new_pt.longitude,y:new_pt.latitude}]);
                                                var f = new GeometryFeature(line);
                                                f.setStroke({color: start.colour, width: 3});
                                                layer.addFeature(f);
                                                start = new_pt;
                                        }

                                }

                                prev = { longitude: longitude, latitude:latitude, colour: colour};

                                var pt = new Point( {x:longitude,y:latitude} );
                            var f = new GeometryFeature(pt);
                            var size = 2;
                            // set the shape properties, fill and stroke
                            //f.setFill([ 0, 128, 128 ]);
                            f.setStroke([ 0, 0, 0, 1 ]);
                            f.setShapeProperties({
                              r : 2
                            });
                            pt.tooltip= (p.speed * 3.6).toFixed(2) + " kph, dist: "+(p.distance / 1000).toFixed(2)+" km, time: "+ (p.time / 60).toFixed(2)+" min";
                            // add the feature to the layer
                            layer.addFeature(f);
                            f.getShape();
                             pt.shape.connect("onmouseover",function(evt){
                                             //evt.relatedTarget
                                             Tooltip.show(pt.tooltip, {x:evt.pageX, y:evt.pageY, w:2, h:2});
                                                });
                             pt.shape.connect("onmouseout", function(){
                                                                //Tooltip.hide(pt.shape);
                                                        });
                        });
                        console.log("Min speed : "+mins+" Max speed : "+ maxs);
                        console.log(min.latitude+" , "+min.longitude+" / "+max.latitude+" , "+max.longitude);
                    map.fitTo({
                    bounds :[ min.longitude,min.latitude,max.longitude,max.latitude ]
                    });

                });
            });
            });
        }

        function create_search_tab( main )
        {
        }

        function create_main_layout()
        {
                require(["dijit/registry", "dijit/layout/BorderContainer",
                    "dijit/layout/TabContainer", "dijit/layout/ContentPane", "dijit/layout/SplitContainer","dijit/form/Button","dojo/domReady!"],
                function(registry, BorderContainer, TabContainer, ContentPane, SplitContainer, Button){
                        // create the BorderContainer and attach it to our appLayout div
                        var appLayout = new BorderContainer({
                            design: "headline"
                        }, "appLayout");

                        // create the TabContainer
                        var contentTabs = new TabContainer({
                            region: "center",
                            id: "contentTabs",
                            tabPosition: "top",
                            "class": "centerPanel"
                        });

                        // add the TabContainer as a child of the BorderContainer
                        appLayout.addChild( contentTabs );

                        // create and add the BorderContainer edge regions
                        appLayout.addChild(
                            new ContentPane({
                                region: "top",
                                "class": "edgePanel",
                                content: "Header content (top)"
                            })
                        );
                        appLayout.addChild(
                            new ContentPane({
                                region: "left",
                                id: "leftCol", "class": "edgePanel",
                                content: "Sidebar content (left)",
                                splitter: true
                            })
                        );

                        var tabs = new Array();
                        tabs.push( new ContentPane({ title: "Recent outings", id:"recent", factory: create_recent_outings_tab } ));
                        tabs.push( new ContentPane({ title: "Search", id:"search", factory: create_search_tab } ));
                        tabs.push( new ContentPane({ title: "Add a new outing", id:"add", factory: create_new_outing_tab } ));
                        for( var tab of tabs )
                        {
                                tab.factory( tab );
                                contentTabs.addChild( tab );
                                if( hashes.tab == tab.id )
                                        contentTabs.selectChild( tab );
                        }

                        contentTabs.watch("selectedChildWidget", function(name, oval, nval){
                                hashes.tab = nval.id;
                                update_url();
                                            });


                        // start up and do layout
                        appLayout.startup();
                });
        }
        create_main_layout();
        </script>
    </body>
</html>
